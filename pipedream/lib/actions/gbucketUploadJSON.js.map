{"version":3,"file":"gbucketUploadJSON.js","sources":["../../src/actions/gbucketUploadJSON.ts"],"sourcesContent":["export default {\n  name: \"GBucket - Upload JSON to Route\",\n  description: \"Uploads a JSON file to a GBucket route\",\n  key: \"gbucket_uploadJsonToRoute\",\n  version: \"1.0.11\",\n  type: \"action\",\n  props: {\n    googleCloud: {\n      type: \"app\",\n      app: \"google_cloud\",\n    },\n    webhookTrigger: {\n      type: \"object\",\n    },\n  },\n  async run() {\n    /**\n const tokenData: TokenData = {\n    address: tokenFrag.address,\n    chainIdHex: chainIdHex,\n    chainIdDecimal: parseInt(chainIdHex, 16).toString(),\n    decimals: tokenMold.decimals,\n    logoURI: tokenMold.logoURI,\n    name: tokenMold.name,\n    priceOracle: tokenMold.priceOracle,\n    symbol: tokenMold.symbol,\n  };\n  await axios.post(\"https://89f633ef6cb67740697f3c0885695a46.m.pipedream.net\", {\n    semvar: \"0.0.1-sandbox\",\n    chainIdHex: \"0x61\",\n    prefix: \"tokens\",\n    bucket: \"guildfx-exchange.appspot.com\"\n    data: tokenData,\n  });\n */\n\n    // Required workaround to get the @google-cloud/storage package\n    // working correctly on Pipedream\n    require(\"@dylburger/umask\")();\n\n    const { Storage } = require(\"@google-cloud/storage\");\n\n    const key = JSON.parse((this as any).googleCloud.$auth.key_json);\n\n    const encodeURISafe = (stringFragment: string) =>\n      encodeURIComponent(stringFragment)\n        .replace(/'/g, \"%27\")\n        .replace(/\"/g, \"%22\");\n\n    // Creates a client from a Google service account key.\n    // See https://cloud.google.com/nodejs/docs/reference/storage/1.6.x/global#ClientConfig\n    const storage = new Storage({\n      projectId: key.project_id,\n      credentials: {\n        client_email: key.client_email,\n        private_key: key.private_key,\n      },\n    });\n\n    // prefix = 'tokens' | 'crowdsales'\n    const { data, semvar, chainIdHex, prefix, bucket } = (this as any)\n      .webhookTrigger.object;\n    const filePath = `v/${semvar}/${chainIdHex}/${prefix}/${data.address}.json`;\n    console.log(\n      `⏳ Uploading ${\n        data.symbol\n      } to Cloud Storage Bucket as https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodeURISafe(\n        filePath\n      )}?alt=media \\n`\n    );\n    await storage.bucket(bucket).file(filePath).save(JSON.stringify(data));\n    await storage.bucket(bucket).file(filePath).makePublic();\n    console.log(`✅ Uploaded \\n`);\n  },\n};\n"],"names":[],"mappings":";;AAAA,wBAAe;IACb,IAAI,EAAE,gCAAgC;IACtC,WAAW,EAAE,wCAAwC;IACrD,GAAG,EAAE,2BAA2B;IAChC,OAAO,EAAE,QAAQ;IACjB,IAAI,EAAE,QAAQ;IACd,KAAK,EAAE;QACL,WAAW,EAAE;YACX,IAAI,EAAE,KAAK;YACX,GAAG,EAAE,cAAc;SACpB;QACD,cAAc,EAAE;YACd,IAAI,EAAE,QAAQ;SACf;KACF;IACD,MAAM,GAAG;;;;;;;;;;;;;;;;;;;;;;QAuBP,OAAO,CAAC,kBAAkB,CAAC,EAAE,CAAC;QAE9B,MAAM,EAAE,OAAO,EAAE,GAAG,OAAO,CAAC,uBAAuB,CAAC,CAAC;QAErD,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAE,IAAY,CAAC,WAAW,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;QAEjE,MAAM,aAAa,GAAG,CAAC,cAAsB,KAC3C,kBAAkB,CAAC,cAAc,CAAC;aAC/B,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC;aACpB,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;;;QAI1B,MAAM,OAAO,GAAG,IAAI,OAAO,CAAC;YAC1B,SAAS,EAAE,GAAG,CAAC,UAAU;YACzB,WAAW,EAAE;gBACX,YAAY,EAAE,GAAG,CAAC,YAAY;gBAC9B,WAAW,EAAE,GAAG,CAAC,WAAW;aAC7B;SACF,CAAC,CAAC;;QAGH,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,UAAU,EAAE,MAAM,EAAE,MAAM,EAAE,GAAI,IAAY;aAC/D,cAAc,CAAC,MAAM,CAAC;QACzB,MAAM,QAAQ,GAAG,KAAK,MAAM,IAAI,UAAU,IAAI,MAAM,IAAI,IAAI,CAAC,OAAO,OAAO,CAAC;QAC5E,OAAO,CAAC,GAAG,CACT,eACE,IAAI,CAAC,MACP,2EAA2E,MAAM,MAAM,aAAa,CAClG,QAAQ,CACT,eAAe,CACjB,CAAC;QACF,MAAM,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC;QACvE,MAAM,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,UAAU,EAAE,CAAC;QACzD,OAAO,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;KAC9B;CACF;;;;"}