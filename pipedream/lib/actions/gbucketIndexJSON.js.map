{"version":3,"file":"gbucketIndexJSON.js","sources":["../../src/actions/gbucketIndexJSON.ts"],"sourcesContent":["export default {\n  name: \"GBucket - Index JSON on Route\",\n  description: \"Indexes a GBucket route with its known addresses\",\n  key: \"gbucket_IndexJsonToRoute\",\n  version: \"1.0.1\",\n  type: \"action\",\n  props: {\n    googleCloud: {\n      type: \"app\",\n      app: \"google_cloud\",\n    },\n    webhookTrigger: {\n      type: \"object\",\n    },\n  },\n  async run() {\n    /**\n const tokenData: TokenData = {\n    address: tokenFrag.address,\n    chainIdHex: chainIdHex,\n    chainIdDecimal: parseInt(chainIdHex, 16).toString(),\n    decimals: tokenMold.decimals,\n    logoURI: tokenMold.logoURI,\n    name: tokenMold.name,\n    priceOracle: tokenMold.priceOracle,\n    symbol: tokenMold.symbol,\n  };\n  await axios.post(\"https://25a6aaa1c164a3160906727a7b1ed065.m.pipedream.net\", {\n    semvar: \"0.0.1-sandbox\",\n    chainIdHex: \"0x61\",\n    prefix: \"tokens\",\n    bucket: \"guildfx-exchange.appspot.com\"\n    data: tokenData,\n  });\n */\n\n    // Required workaround to get the @google-cloud/storage package\n    // working correctly on Pipedream\n    require(\"@dylburger/umask\")();\n\n    const { Storage } = require(\"@google-cloud/storage\");\n\n    const key = JSON.parse((this as any).googleCloud.$auth.key_json);\n\n    const encodeURISafe = (stringFragment: string) =>\n      encodeURIComponent(stringFragment)\n        .replace(/'/g, \"%27\")\n        .replace(/\"/g, \"%22\");\n\n    // Creates a client from a Google service account key.\n    // See https://cloud.google.com/nodejs/docs/reference/storage/1.6.x/global#ClientConfig\n    const storage = new Storage({\n      projectId: key.project_id,\n      credentials: {\n        client_email: key.client_email,\n        private_key: key.private_key,\n      },\n    });\n\n    const { semvar, chainIdHex, prefix, bucket } = (this as any).webhookTrigger\n      .object;\n    const filePath = `v/${semvar}/${chainIdHex}/${prefix}/index.json`;\n    const routePath = `v/${semvar}/${chainIdHex}/${prefix}/`;\n\n    // reindex\n    const options = {\n      prefix: routePath,\n      delimiter: \"/\",\n    };\n\n    // Lists files in the bucket, filtered by a prefix\n    const result = await storage.bucket(bucket).getFiles(options);\n    const routes: any[] = [];\n    result[0]\n      .filter(\n        (f: any) =>\n          f.name.indexOf(\"index.json\") === -1 &&\n          f.name.indexOf(\"defaults.json\") === -1\n      )\n      .forEach((file: any) => {\n        console.log(file.name);\n        routes.push(file.name);\n      });\n    console.log(\n      `⏳ Uploading index to Cloud Storage Bucket as https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodeURISafe(\n        filePath\n      )}?alt=media \\n`\n    );\n    await storage.bucket(bucket).file(filePath).save(JSON.stringify(routes));\n    await storage.bucket(bucket).file(filePath).makePublic();\n    console.log(`✅ Uploaded \\n`);\n  },\n};\n"],"names":[],"mappings":";;AAAA,uBAAe;IACb,IAAI,EAAE,+BAA+B;IACrC,WAAW,EAAE,kDAAkD;IAC/D,GAAG,EAAE,0BAA0B;IAC/B,OAAO,EAAE,OAAO;IAChB,IAAI,EAAE,QAAQ;IACd,KAAK,EAAE;QACL,WAAW,EAAE;YACX,IAAI,EAAE,KAAK;YACX,GAAG,EAAE,cAAc;SACpB;QACD,cAAc,EAAE;YACd,IAAI,EAAE,QAAQ;SACf;KACF;IACD,MAAM,GAAG;;;;;;;;;;;;;;;;;;;;;;QAuBP,OAAO,CAAC,kBAAkB,CAAC,EAAE,CAAC;QAE9B,MAAM,EAAE,OAAO,EAAE,GAAG,OAAO,CAAC,uBAAuB,CAAC,CAAC;QAErD,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAE,IAAY,CAAC,WAAW,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;QAEjE,MAAM,aAAa,GAAG,CAAC,cAAsB,KAC3C,kBAAkB,CAAC,cAAc,CAAC;aAC/B,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC;aACpB,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;;;QAI1B,MAAM,OAAO,GAAG,IAAI,OAAO,CAAC;YAC1B,SAAS,EAAE,GAAG,CAAC,UAAU;YACzB,WAAW,EAAE;gBACX,YAAY,EAAE,GAAG,CAAC,YAAY;gBAC9B,WAAW,EAAE,GAAG,CAAC,WAAW;aAC7B;SACF,CAAC,CAAC;QAEH,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,MAAM,EAAE,MAAM,EAAE,GAAI,IAAY,CAAC,cAAc;aACxE,MAAM,CAAC;QACV,MAAM,QAAQ,GAAG,KAAK,MAAM,IAAI,UAAU,IAAI,MAAM,aAAa,CAAC;QAClE,MAAM,SAAS,GAAG,KAAK,MAAM,IAAI,UAAU,IAAI,MAAM,GAAG,CAAC;;QAGzD,MAAM,OAAO,GAAG;YACd,MAAM,EAAE,SAAS;YACjB,SAAS,EAAE,GAAG;SACf,CAAC;;QAGF,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;QAC9D,MAAM,MAAM,GAAU,EAAE,CAAC;QACzB,MAAM,CAAC,CAAC,CAAC;aACN,MAAM,CACL,CAAC,CAAM,KACL,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;YACnC,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC,CACzC;aACA,OAAO,CAAC,CAAC,IAAS;YACjB,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACvB,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;SACxB,CAAC,CAAC;QACL,OAAO,CAAC,GAAG,CACT,4FAA4F,MAAM,MAAM,aAAa,CACnH,QAAQ,CACT,eAAe,CACjB,CAAC;QACF,MAAM,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC;QACzE,MAAM,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,UAAU,EAAE,CAAC;QACzD,OAAO,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;KAC9B;CACF;;;;"}